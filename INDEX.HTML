<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Flight Radar io26</title>
    <style>
        :root { --blue-ticket: #34a8c9; --gray-bg: #f2f2f2; }
        body { background: var(--gray-bg); font-family: 'Helvetica', Arial; display: flex; flex-direction: column; align-items: center; padding: 40px; }
        
        /* Barra de Busca */
        .search-area { width: 850px; margin-bottom: 20px; display: flex; gap: 10px; }
        .search-area input { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; }
        .search-area button { background: var(--blue-ticket); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }

        /* Bilhete */
        .ticket {
            width: 850px; height: 320px; background: white; border-radius: 20px;
            display: flex; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 1px solid #ddd; position: relative;
        }
        .stub { width: 200px; border-right: 2px dashed #ddd; padding: 20px; position: relative; }
        .main-body { flex: 1; display: flex; flex-direction: column; }
        
        .blue-bar { background: var(--blue-ticket); height: 70px; display: flex; align-items: center; padding: 0 30px; justify-content: space-between; color: white; }
        .blue-bar h1 { margin: 0; font-size: 32px; letter-spacing: 2px; }

        .content { padding: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .data { display: flex; flex-direction: column; }
        .label { color: #aaa; font-size: 11px; font-weight: bold; text-transform: uppercase; margin-bottom: 4px; }
        .val { color: #333; font-size: 24px; font-weight: bold; }
        .blue-val { color: var(--blue-ticket); }

        .seat-box { background: var(--blue-ticket); color: white; padding: 10px; margin-top: 20px; display: flex; align-items: center; justify-content: space-around; }

        /* Barcode */
        .barcode { position: absolute; right: 40px; bottom: 30px; cursor: pointer; }
        .barcode img { height: 70px; }

        /* Faixa Aeroporto */
        .status-strip {
            width: 850px; background: #000; color: #ffcc00; padding: 25px;
            margin-top: 30px; font-family: 'Courier New', monospace; font-size: 22px;
            text-transform: uppercase; border-radius: 10px; text-align: center;
        }
    </style>
</head>
<body>

    <div class="search-area">
        <input type="text" id="manualLoc" placeholder="Digite endereço ou CEP se o GPS falhar...">
        <button onclick="getManualLocation()">PESQUISAR</button>
    </div>

    <div class="ticket">
        <div class="stub">
            <div class="label">FLIGHT</div>
            <div id="stub-flight" class="val">---</div>
            <div style="margin-top:20px" class="label">GATE</div>
            <div class="val">02</div>
            <div class="seat-box">
                <span style="font-size: 22px; font-weight: bold;">19 A</span>
                <span style="font-size: 10px;">SEAT<br>FIRST CLASS</span>
            </div>
        </div>
        <div class="main-body">
            <div class="blue-bar">
                <span style="font-weight: bold;">YOUR COMPANY</span>
                <h1>BOARDING PASS</h1>
            </div>
            <div class="content">
                <div class="data"><div class="label">AIRCRAFT IDENTIFICATION</div><div id="ac-id" class="val">---</div></div>
                <div class="data"><div class="label">FLIGHT IDENTIFICATION</div><div id="fl-id" class="val blue-val">---</div></div>
                <div class="data"><div class="label">DISTANCE TO ME</div><div id="dist" class="val blue-val">0 KM</div></div>
                <div class="data"><div class="label">FLIGHT DIRECTION</div><div id="dir" class="val">---</div></div>
            </div>
            <div class="barcode" onclick="openFlightMap()">
                <img id="barcode-img" src="https://bwipjs-api.metafloor.com/?bcid=code128&text=WAITING&scale=2">
                <div style="font-size: 8px; color: #888; text-align: center;">LOCALIZAR NO MAPA</div>
            </div>
        </div>
    </div>

    <div class="status-strip" id="flap-display">RADAR EM BUSCA...</div>

    <audio id="alert-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        let coords = null;
        let lastFlightId = null;
        let currentFlight = null;

        function splitFlap(text) {
            const display = document.getElementById('flap-display');
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 :.";
            let iterations = 0;
            const target = text.toUpperCase();
            
            const timer = setInterval(() => {
                display.innerText = target.split('').map((char, i) => {
                    if (iterations > i + 15) return char;
                    return chars[Math.floor(Math.random() * chars.length)];
                }).join('');
                
                if (iterations > target.length + 20) clearInterval(timer);
                iterations++;
            }, 30);
        }

        async function updateRadar() {
            if(!coords) return;
            const res = await fetch(`/api/radar?lat=${coords.lat}&lon=${coords.lon}`);
            const data = await res.json();
            
            if (data.flights && data.flights.length > 0) {
                const f = data.flights[0];
                currentFlight = f;
                
                document.getElementById('ac-id').innerText = f.icao;
                document.getElementById('fl-id').innerText = f.callsign;
                document.getElementById('stub-flight').innerText = f.callsign;
                document.getElementById('dist').innerText = f.dist + " KM";
                document.getElementById('dir').innerText = f.heading + "°";
                document.getElementById('barcode-img').src = `https://bwipjs-api.metafloor.com/?bcid=code128&text=${f.icao}`;

                if (f.icao !== lastFlightId) {
                    document.getElementById('alert-sound').play();
                    lastFlightId = f.icao;
                }
                
                splitFlap(`IDENTIFICADO: ${f.callsign} | ICAO: ${f.icao} | ALT: ${f.alt}M | ${data.weather}`);
            } else {
                splitFlap(`RADAR BUSCANDO... | ${data.weather}`);
            }
        }

        function getManualLocation() {
            const val = document.getElementById('manualLoc').value;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${val}`)
                .then(r => r.json()).then(d => {
                    if(d[0]) {
                        coords = { lat: d[0].lat, lon: d[0].lon };
                        splitFlap("LOCALIZAÇÃO MANUAL ATUALIZADA");
                        updateRadar();
                    }
                });
        }

        function openFlightMap() {
            if (currentFlight) {
                const url = `https://www.google.com/maps/dir/${coords.lat},${coords.lon}/${currentFlight.lat},${currentFlight.lon}/@${currentFlight.lat},${currentFlight.lon},10z`;
                window.open(url, '_blank');
            }
        }

        navigator.geolocation.getCurrentPosition(p => {
            coords = { lat: p.coords.latitude, lon: p.coords.longitude };
            splitFlap("RADAR CONECTADO - BUSCANDO VOOS");
            updateRadar();
            setInterval(updateRadar, 30000);
        }, () => splitFlap("GPS INDISPONÍVEL. INSIRA O ENDEREÇO ACIMA."));
    </script>
</body>
</html>
